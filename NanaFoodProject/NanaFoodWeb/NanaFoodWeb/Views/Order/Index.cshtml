@using NanaFoodWeb.Models.Dto
@model NanaFoodWeb.Models.Order
@{
    ViewData["Title"] = "Order Page";
    List<CartResponseDto> cartDetails = new List<CartResponseDto>();
    if (ViewBag.cartdetails != null)
    {
        cartDetails = ViewBag.cartdetails;
    }
}
<form asp-action="Payment" asp-controller="Order" method="post">
<div class="container">
    <div class="card shadow rounded-3">
    <div class="card-header">
        <h1 style="font-family: 'Roboto', sans-serif;" >Thông tin đặt hàng</h1>
    </div>
    <div class="card-body">
        <form method="post">
            <div class="row">
                <div class="col-md-6 p-4 bg-white border-end border-3">
                    <h2 class="text-lg font-semibold mb-4">Thông tin thanh toán</h2>

                    <div class="mb-3">
                        <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                        <input type="text" asp-for=FullName name="FullName" class="form-control" placeholder="Họ và tên đầy đủ">
                        <span asp-validation-for=FullName class="text-danger"> @* Thông báo lỗi sẽ xuất hiện ở đây (nếu có) *@ </span>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                        <input type="text" asp-for=PhoneNumber name="PhoneNumber" class="form-control" placeholder="08588xxxxx">
                        <span class="text-danger"> @* Thông báo lỗi sẽ xuất hiện ở đây (nếu có) *@ </span>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Địa chỉ nhận hàng <span class="text-danger">*</span></label>

                        <div class="form-group mt-2 mb-2">
                            <label>Tỉnh/Thành phố: </label>
                            <select id="ProvinceList" name="Province" class="form-select">
                                <option value=""> Hãy chọn tỉnh/thành phố </option>
                                    @foreach (var item in (List<SelectListItem>)ViewBag.ProvinceList)
                                    {
                                            <option value="@item.Value">@item.Text</option>
                                    }
                            </select>
                        </div>

                        <div class="form-group mt-2 mb-2">
                            <label>Quận huyện: </label>
                            <select id="DistrictList" name="District" class="form-select">
                                <option value=""> Hãy chọn quận/huyện </option>
                            </select>
                        </div>

                        <div class="form-group mt-2 mb-2">
                            <label>Phường xã: </label>
                            <select id="WardList" name="Ward" class="form-select">
                                <option value=""> Hãy chọn phường/xã </option>
                            </select>
                        </div>

                        <div class="form-group mt-2 mb-2">
                            <label>Số nhà và tên đường: </label>
                            <input name="Address" asp-for="Address" class="form-control" placeholder="hãy nhập số nhà và tên đường của bạn ở đây" />
                        </div>

                        <!-- Dropdown hiển thị dịch vụ -->
                        <div class="form-group mt-2 mb-2" hidden>
                            <label>Dịch vụ: </label>
                            <select id="ServiceList" class="form-select">
                                <option value=""> Hãy chọn dịch vụ </option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Lưu ý</label>
                        <textarea name="Note" class="form-control" placeholder="Lưu ý dành cho đơn vị vận chuyển"></textarea>
                        <span class="text-danger"> @* Thông báo lỗi sẽ xuất hiện ở đây (nếu có) *@ </span>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Phương thức thanh toán <span class="text-danger">*</span></label>
                        <select name="PaymentType" asp-for=PaymentType class="form-select">
                            <option value="COD">Cash on Delivery</option>
                            <option value="MOMO">Momo</option>
                            <option value="VNPAY">VNpay</option>
                        </select>
                        <span class="text-danger"> @* Thông báo lỗi sẽ xuất hiện ở đây (nếu có) *@ </span>
                    </div>
                </div>

                <div class="col-md-6 p-4 bg-white">
                    <h2 class="text-lg mb-4 text-center">Giỏ hàng</h2>

                    <div class="mb-4">
                        <table class="table text-center">
                            <thead>
                                <tr>
                                    <th>Tên sản phẩm</th>
                                    <th>Số lượng</th>
                                    <th>Tổng</th>
                                </tr>
                            </thead>
                            <tbody>
                                    @foreach (var item in cartDetails)
                                    {
                                        <tr>
                                            <td>@item.ProductName</td>
                                            <td class="text-center">@item.Quantity</td>
                                            <td class="text-center">@item.Total.ToString("#,##")</td>
                                        </tr>
                                    }
                                </tbody>
                        </table>
                    </div>
                    <hr />
                        <div class="btn-group w-100">
                            <input type="text" class="form-control" placeholder="Nhập mã giảm giá" style="width: 379.656px;">
                            <button type="button" class="btn btn-outline-danger" style="height: 36px; transform: translate(0px, 12px); position: relative; top: -1px;">Áp dụng</button>
                        </div>
                        <hr />
                    <div class="d-flex justify-content-between mt-2 mb-2">
                                <strong>Tổng đơn hàng:</strong> <span>@cartDetails.Sum(x => x.Total).ToString("#,##") VNĐ</span>
                        </div>
                    <div class="d-flex justify-content-between mt-2 mb-2">
                        <strong>Phí Ship:</strong> <span id="shippingFee">0 VNĐ</span>
                    </div>
                        <div class="d-flex justify-content-between mt-2 mb-2">
                                <strong>Tổng thanh toán:</strong> <span id="totalPay">@cartDetails.Sum(x => x.Total).ToString("#,##") VNĐ</span>
                        </div>

                    <button type="submit" class="btn btn-primary w-100">Thanh toán</button>
                </div>
            </div>
        </form>
    </div>
</div>
</div>

</form>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Lắng nghe sự kiện khi thay đổi tỉnh/thành phố
            $('#ProvinceList').change(function () {
                var provinceId = $(this).val(); // Lấy giá trị ProvinceID

                if (provinceId) {
                    // Reset các dropdown Phường/Xã, Dịch vụ và phí ship
                    $('#DistrictList').empty().append('<option value=""> Hãy chọn quận/huyện </option>');
                    $('#WardList').empty().append('<option value=""> Hãy chọn phường/xã </option>');
                    $('#ServiceList').empty().append('<option value=""> Hãy chọn dịch vụ </option>');

                    // Gửi yêu cầu AJAX để lấy danh sách quận/huyện
                    $.ajax({
                        url: '@Url.Action("GetDistricts", "Order")',
                        type: 'GET',
                        data: { provinceId: provinceId },
                        success: function (data) {
                            $('#DistrictList').empty().append('<option value=""> Hãy chọn quận/huyện </option>');
                            $.each(data, function (i, district) {
                                $('#DistrictList').append('<option value="' + district.value + '">' + district.text + '</option>');
                            });
                        },
                        error: function () {
                            alert("Không thể lấy danh sách quận/huyện");
                        }
                    });
                } else {
                    // Reset danh sách quận/huyện, phường/xã, dịch vụ và phí ship nếu không chọn tỉnh/thành phố
                    $('#DistrictList').empty().append('<option value=""> Hãy chọn quận/huyện </option>');
                    $('#WardList').empty().append('<option value=""> Hãy chọn phường/xã </option>');
                    $('#ServiceList').empty().append('<option value=""> Hãy chọn dịch vụ </option>');
                }
            });

            // Lắng nghe sự kiện khi thay đổi quận/huyện
            $('#DistrictList').change(function () {
                var districtId = $(this).val(); // Lấy giá trị DistrictID

                if (districtId) {
                    // Reset dropdown Phường/Xã và Dịch vụ
                    $('#WardList').empty();
                    $('#WardList').append('<option value=""> Hãy chọn phường/xã </option>');

                    $('#ServiceList').empty();
                    $('#ServiceList').append('<option value=""> Hãy chọn dịch vụ </option>');

                    // Gửi yêu cầu AJAX để lấy danh sách phường/xã
                    $.ajax({
                        url: '@Url.Action("GetWards", "Order")',
                        type: 'GET',
                        data: { districtId: districtId },
                        success: function (data) {
                            $('#WardList').empty();
                            $('#WardList').append('<option value=""> Hãy chọn phường/xã </option>');
                            $.each(data, function (i, ward) {
                                $('#WardList').append('<option value="' + ward.value + '">' + ward.text + '</option>');
                            });
                        },
                        error: function () {
                            alert("Không thể lấy danh sách phường/xã");
                        }
                    });

                    // Gửi yêu cầu AJAX để lấy danh sách dịch vụ
                    $.ajax({
                        url: '@Url.Action("GetAvailableService", "Order")', // Action để lấy danh sách dịch vụ
                        type: 'GET',
                        data: { fromDistrict: 1454, toDistrict: districtId }, // Gửi từ quận 12 đến quận người dùng chọn
                        success: function (data) {
                            $('#ServiceList').empty();
                            $('#ServiceList').append('<option value=""> Hãy chọn dịch vụ </option>');
                            $.each(data, function (i, service) {
                                $('#ServiceList').append('<option value="' + service.value + '">' + service.text + '</option>');
                            });

                            // Tự động chọn dịch vụ đầu tiên
                            if (data.length > 0) {
                                $('#ServiceList').val(data[0].value);
                            }
                        },
                        error: function () {
                            alert("Không thể lấy danh sách dịch vụ");
                        }
                    });

                } else {
                    $('#WardList').empty();
                    $('#WardList').append('<option value=""> Hãy chọn phường/xã </option>');
                    $('#ServiceList').empty();
                    $('#ServiceList').append('<option value=""> Hãy chọn dịch vụ </option>');
                }
            });

            // Lắng nghe sự kiện khi thay đổi phường/xã và lấy dịch vụ
            $('#WardList').change(function () {
                var wardId = $(this).val(); // Lấy giá trị WardID
                var toDistrict = $('#DistrictList').val(); // Lấy giá trị quận huyện

                if (toDistrict) {
                    // Gửi yêu cầu AJAX để lấy dịch vụ
                    $.ajax({
                        url: '@Url.Action("GetAvailableService", "Order")',
                        type: 'GET',
                        data: { fromDistrict: 1454, toDistrict: toDistrict }, // Gửi từ quận 12 đến quận người dùng chọn
                        success: function (data) {
                            $('#ServiceList').empty();
                            $('#ServiceList').append('<option value=""> Hãy chọn dịch vụ </option>');
                            $.each(data, function (i, service) {
                                $('#ServiceList').append('<option value="' + service.value + '">' + service.text + '</option>');
                            });

                            // Tự động chọn dịch vụ đầu tiên
                            if (data.length > 0) {
                                $('#ServiceList').val(data[0].value);
                            }
                        },
                        error: function () {
                            alert("Không thể lấy danh sách dịch vụ");
                        }
                    });
                } else {
                    $('#ServiceList').empty();
                    $('#ServiceList').append('<option value=""> Hãy chọn dịch vụ </option>');
                }
            });
            // Khi thay đổi phường/xã và dịch vụ, gửi yêu cầu tính phí ship
            $('#WardList, #ServiceList').change(function () {
                var wardCode = $('#WardList').val();
                var toDistrictId = $('#DistrictList').val();
                var serviceId = $('#ServiceList').val();

                if (wardCode && toDistrictId && serviceId) {
                    // Gọi AJAX để tính phí vận chuyển
                    $.ajax({
                        url: '@Url.Action("CalculateShippingFee", "Order")', // Gọi đến action
                        type: 'POST',
                        data: {
                            serviceId: serviceId,      // ID của dịch vụ đã chọn
                            toDistrictId: toDistrictId, // ID quận được chọn
                            wardCode: wardCode         // Mã phường được chọn
                        },
                        success: function (response) {
                            // Hiển thị phí ship ở phần tử #shippingFee
                            var shippingFee = response.data;
                            var roundedShippingFee = Math.round(shippingFee / 1000) * 1000;
                            var formattedFee = roundedShippingFee.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); // Thêm dấu phẩy vào các số hàng nghìn
                            $('#shippingFee').text(formattedFee + ' VNĐ'); // Hiển thị phí ship
                        },
                        error: function () {
                            alert("Không thể tính phí ship");
                        }
                    });
                }
            });

            // Thay đổi tổng tiền mỗi khi phí ship thay đổi
             const observer = new MutationObserver(() => {
                var currentTotal = document.getElementById('totalPay').textContent.trim();
                var ship = document.getElementById('shippingFee').textContent.trim();
                var totalPayNumber = parseInt(currentTotal.replace(/,| VNĐ/g, ''));
                var shipInteger =  parseInt(ship.replace(/,| VNĐ/g, ''));
                currentTotal = totalPayNumber + shipInteger;
                var formattedFee = currentTotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                $('#totalPay').text(formattedFee + ' VNĐ');
            });

            observer.observe(document.getElementById('shippingFee'), { childList: true });
        });
    </script>
}

